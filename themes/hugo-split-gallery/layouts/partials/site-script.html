{{ range slice "bootstrap/*.js" "jquery/*.js" "fancybox/*.js" "leaflet/*.js" "togeojson/*.js" "leaflet.awesome-markers/*.min.js" }}
{{ $secureJS := resources.GetMatch (printf "/vendor/%s" .) | resources.Fingerprint "sha512" }}
<script src="{{ $secureJS.Permalink }}" type="text/javascript" integrity="{{ $secureJS.Data.Integrity }}"></script>
{{ end }}

{{ if (default false ($.Site.Params.enableDownloadAll)) }}
{{ range slice "jszip/*.js" "jszip-utils/*.js" "file-saver/*.js" }}
{{ $secureJS := resources.GetMatch (printf "/vendor/%s" .) | resources.Fingerprint "sha512" }}
<script src="{{ $secureJS.Permalink }}" type="text/javascript" integrity="{{ $secureJS.Data.Integrity }}"></script>
{{ end }}
{{ end }}

{{ with resources.GetMatch "/hugo-split-gallery/map.js" }}<script src="{{ .Permalink }}"></script>{{ end }}
{{ if (default false ($.Site.Params.enableDownloadAll)) }}
{{ with resources.GetMatch "/hugo-split-gallery/zip.js" }}<script src="{{ .Permalink }}"></script>{{ end }}
{{ end }}

{{ $fancyboxParams := resources.GetMatch "/hugo-split-gallery/fancybox.js" | resources.ExecuteAsTemplate "hugo-split-gallery/fancybox.js" . }}
<script src="{{ $fancyboxParams.Permalink }}"></script>
{{ with resources.GetMatch (printf "/hugo-split-gallery/fancybox.%s.js" .Site.Language.Lang) }}<script src="{{ .Permalink }}"></script>{{ end }}

{{ range .Site.Params.customJs }}
<script src="{{ relURL (.) }}"></script>
{{ end }}

<script>
// Handle page transitions including back/forward navigation
let isNavigating = false;

// Trigger fade-in as early as possible
document.addEventListener('DOMContentLoaded', function() {
  if (!isNavigating) {
    setTimeout(() => {
      requestAnimationFrame(() => {
        document.body.classList.add('page-loaded');
      });
    }, 20);
  }
  
  // Fade in video if present
  const video = document.getElementById('video-background');
  if (video) {
    video.addEventListener('loadeddata', function() {
      video.classList.add('loaded');
    });
    if (video.readyState >= 3) {
      video.classList.add('loaded');
    }
  }
});

window.addEventListener('load', function() {
  document.body.classList.add('page-loaded');
  
  const video = document.getElementById('video-background');
  if (video) video.classList.add('loaded');
});

// Handle browser back/forward buttons
window.addEventListener('pageshow', function(event) {
  // Reset state when page is shown from cache (back button)
  if (event.persisted) {
    isNavigating = false;
    document.body.classList.add('page-loaded');
    const video = document.getElementById('video-background');
    if (video) video.classList.add('loaded');
  }
});

window.addEventListener('pagehide', function() {
  isNavigating = true;
});

// Handle link clicks
document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a');
  
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      
      if (!href || 
          href.startsWith('#') || 
          href.startsWith('http') || 
          href.startsWith('mailto:') || 
          href.startsWith('tel:') ||
          this.target === '_blank') {
        return;
      }
      
      e.preventDefault();
      isNavigating = true;
      
      // Fade out video
      const video = document.getElementById('video-background');
      if (video) video.classList.remove('loaded');
      
      // Fade out body
      document.body.classList.remove('page-loaded');
      
      setTimeout(() => {
        window.location.href = href;
      }, 150);
    });
  });
});
</script>